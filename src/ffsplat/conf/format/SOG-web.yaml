profile: SOG-web
profile_version: 0.1

scene:
  primitives: 3DGS-INRIA
  params:
    - means
    - scales
    - opacities
    - quaternions
    - sh

fields:
  sh:
    - split:
        to_field_list: [f_dc, f_rest]
        split_size_or_sections: [1, 15]
        dim: 1
        squeeze: false

  means:
    - remapping:
        method: signed-log
    - remapping:
        method: channelwise-minmax
        min: 0
        max: 65535
        dim: 2
    - to_dtype:
        dtype: uint16
        round_to_int: true
    - split_bytes:
        to_fields_with_prefix: means_bytes_
        num_bytes: 2

  _:
    - plas:
        prune_by: opacities
        scaling_fn: standardize
        # activated: true
        shuffle: true
        improvement_break: 1e-4
        # improvement_break: 0.1
        weights:
          means_bytes_0: 0.1
          means_bytes_1: 1.0
          f_dc: 1.0
          f_rest: 0.0
          opacities: 0.0
          scales: 1.0
          quaternions: 0.0
    - to_tmp_field: sorted_indices

  means_bytes_0:
    - reindex:
        index_field: sorted_indices

  means_bytes_1:
    - reindex:
        index_field: sorted_indices

  f_dc:
    - flatten:
        start_dim: 1
    - reindex:
        index_field: sorted_indices
    - remapping:
        method: channelwise-minmax
        min: 0.0
        max: 255.0
        dim: 2
    - to_dtype:
        dtype: uint8
        round_to_int: true

  f_rest:
    - permute:
        dims: [0, 2, 1]
    - flatten:
        start_dim: 1
    - reindex:
        index_field: sorted_indices
    - remapping:
        method: channelwise-minmax
        min: 0
        max: 31
        dim: 2
    - to_dtype:
        dtype: uint8
        round_to_int: true
    - split:
        to_fields_with_prefix: f_rest_
        split_size_or_sections: 3
        dim: 2
        squeeze: true

  quaternions:
    - reindex:
        index_field: sorted_indices
    - remapping:
        method: channelwise-minmax
        min: 0
        max: 63
        dim: 2
    - to_dtype:
        dtype: uint8
        round_to_int: true

  scales:
    - reindex:
        index_field: sorted_indices
    - remapping:
        method: log
    - remapping:
        method: channelwise-minmax
        min: 0
        max: 63
        dim: 2
    - to_dtype:
        dtype: uint8
        round_to_int: true

  opacities:
    - reindex:
        index_field: sorted_indices
    - remapping:
        method: inverse-sigmoid
    - remapping:
        method: channelwise-minmax
        min: 0
        max: 63
        dim: 2
    - to_dtype:
        dtype: uint8
        round_to_int: true

files:
  - from_field: opacities
    type: avif
  - from_field: scales
    type: avif
  - from_fields_with_prefix: means_bytes_
    type: avif
  - from_field: quaternions
    type: avif
  - from_field: f_dc
    type: avif
  - from_fields_with_prefix: f_rest_
    type: avif
