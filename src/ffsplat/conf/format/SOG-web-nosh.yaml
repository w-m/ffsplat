profile: SOG-web
profile_version: 0.1

scene:
  primitives: 3DGS-INRIA
  params:
    - means
    - scales
    - opacities
    - quaternions
    - sh

fields:
  - input_fields: [means]
    ops:
      - remapping:
          method: signed-log
      - remapping:
          method: channelwise-minmax
          min: 0
          max: 65535
          dim: 2
      - to_dtype:
          dtype: uint16
          round_to_int: true
      - split_bytes:
          num_bytes: 2
          to_fields_with_prefix: means_bytes_

  - input_fields: [sh]
    ops:
      - split:
          split_size_or_sections: [1]
          dim: 1
          squeeze: false
          to_field_list: [f_dc]

  - input_fields:
      [means_bytes_0, means_bytes_1, f_dc, opacities, scales, quaternions]
    ops:
      - plas:
          prune_by: opacities
          scaling_fn: standardize
          # activated: true
          shuffle: true
          improvement_break: 1e-4
          # improvement_break: 0.1
          to_field: sorted_indices
          weights:
            means_bytes_0: 0.1
            means_bytes_1: 1.0
            f_dc: 1.0
            opacities: 0.0
            scales: 1.0
            quaternions: 0.0

  - input_fields: [means_bytes_0, sorted_indices]
    ops:
      - reindex:
          src_field: means_bytes_0
          index_field: sorted_indices

  - input_fields: [means_bytes_1, sorted_indices]
    ops:
      - reindex:
          src_field: means_bytes_1
          index_field: sorted_indices

  - input_fields: [f_dc]
    ops:
      - flatten:
          start_dim: 1
      - remapping:
          method: channelwise-minmax
          min: 0.0
          max: 255.0
          dim: 1
      - to_dtype:
          dtype: uint8
          round_to_int: true

  - input_fields: [f_dc, sorted_indices]
    ops:
      - reindex:
          src_field: f_dc
          index_field: sorted_indices

  - input_fields: [quaternions, sorted_indices]
    ops:
      - reindex:
          src_field: quaternions
          index_field: sorted_indices

  - input_fields: [quaternions]
    ops:
      - remapping:
          method: channelwise-minmax
          min: 0
          max: 63
          dim: 2
      - to_dtype:
          dtype: uint8
          round_to_int: true

  - input_fields: [scales, sorted_indices]
    ops:
      - reindex:
          src_field: scales
          index_field: sorted_indices

  - input_fields: [scales]
    ops:
      - remapping:
          method: log
      - remapping:
          method: channelwise-minmax
          min: 0
          max: 63
          dim: 2
      - to_dtype:
          dtype: uint8
          round_to_int: true

  - input_fields: [opacities, sorted_indices]
    ops:
      - reindex:
          src_field: opacities
          index_field: sorted_indices

  - input_fields: [opacities]
    ops:
      - remapping:
          method: inverse-sigmoid
      - remapping:
          method: channelwise-minmax
          min: 0
          max: 63
          dim: 2
      - to_dtype:
          dtype: uint8
          round_to_int: true

files:
  - from_field: opacities
    type: avif
    coding_params:
      quality: -1
      chroma: 0
      matrix_coefficients: 0
  - from_field: scales
    type: avif
    coding_params:
      quality: -1
      chroma: 444
      matrix_coefficients: 0
  - from_fields_with_prefix: means_bytes_
    type: avif
    coding_params:
      quality: -1
      chroma: 444
      matrix_coefficients: 0
  - from_field: quaternions
    type: avif
    coding_params:
      quality: -1
      chroma: 444
      matrix_coefficients: 0
  - from_field: f_dc
    type: avif
    coding_params:
      quality: 100
      chroma: 420
      matrix_coefficients: 1
